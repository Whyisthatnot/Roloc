if not game:IsLoaded() then repeat game.Loaded:Wait() until game:IsLoaded() end
-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local Lighting = game:GetService("Lighting")
local Terrain = workspace:FindFirstChildOfClass("Terrain")
local ContentProvider = game:GetService("ContentProvider")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local dataRemoteEvent = ReplicatedStorage:WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent")

-- Configuration
local TELEPORT_DELAY = 0.8
local WINTER_CFRAME = CFrame.new(4623.21924, 248.286758, -1932.66699, -0.480712414, -0.876878381, 2.60472298e-05, -2.60472298e-05, 4.38690186e-05, 1, -0.876878381, 0.480712384, -4.39882278e-05)
local enemyIDList = {"DAMB1","DAMB2","DAMB3"}
local farmEnabled = true
local isRenderOff = true

-- [1] COMBINED BLACK SCREEN & UI SYSTEM
local mainScreen = Instance.new("ScreenGui")
mainScreen.Name = "MainInterface"
mainScreen.IgnoreGuiInset = true
mainScreen.DisplayOrder = 9999

-- Black background (kept permanently)
local blackFrame = Instance.new("Frame")
blackFrame.Size = UDim2.new(1, 0, 1, 0)
blackFrame.BackgroundColor3 = Color3.new(0, 0, 0)
blackFrame.BackgroundTransparency = 0.3  -- Slightly transparent
blackFrame.Parent = mainScreen

-- Loading text (will be replaced with UI)
local loadingText = Instance.new("TextLabel")
loadingText.Size = UDim2.new(1, 0, 0, 50)
loadingText.Position = UDim2.new(0, 0, 0.5, -25)
loadingText.BackgroundTransparency = 1
loadingText.Text = "Đang tối ưu hóa game..."
loadingText.TextColor3 = Color3.new(1, 1, 1)
loadingText.Font = Enum.Font.GothamBold
loadingText.TextSize = 24
loadingText.Parent = blackFrame

mainScreen.Parent = playerGui

-- [2] OPTIMIZATION FUNCTIONS
local function optimizeSystem()
    -- Lighting optimization
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 1e10
    Lighting.Brightness = 0
    Lighting.EnvironmentDiffuseScale = 0
    Lighting.EnvironmentSpecularScale = 0
    Lighting.ClockTime = 14

    -- Terrain optimization
    if Terrain then
        Terrain.WaterWaveSize = 0
        Terrain.WaterWaveSpeed = 0
        Terrain.WaterReflectance = 0
        Terrain.WaterTransparency = 1
    end

    -- Object optimization
    for _, obj in ipairs(game:GetDescendants()) do
        if obj:IsA("Decal") or obj:IsA("Texture") then
            obj.Transparency = 1
        elseif obj:IsA("ParticleEmitter") or obj:IsA("Trail") then
            obj.Enabled = false
        end
    end

    for _, part in ipairs(workspace:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CastShadow = false
        end
    end

    -- Disable default UI
    StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.All, false)
end

-- [3] CREATE MAIN INTERFACE
local function createMainUI()
    -- Remove loading text
    loadingText:Destroy()

    -- Main container
    local uiContainer = Instance.new("Frame")
    uiContainer.Size = UDim2.new(0.3, 0, 0.8, 0)
    uiContainer.Position = UDim2.new(0.02, 0, 0.1, 0)
    uiContainer.BackgroundTransparency = 0.7
    uiContainer.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    uiContainer.Parent = blackFrame

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = uiContainer

    -- Title
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 40)
    title.Position = UDim2.new(0, 0, 0, 10)
    title.BackgroundTransparency = 1
    title.Text = "FPS BOOST VIP"
    title.TextColor3 = Color3.new(1, 0.5, 0)
    title.Font = Enum.Font.GothamBlack
    title.TextSize = 24
    title.Parent = uiContainer

    -- Stats section
    local statsFrame = Instance.new("Frame")
    statsFrame.Size = UDim2.new(0.9, 0, 0, 100)
    statsFrame.Position = UDim2.new(0.05, 0, 0.15, 0)
    statsFrame.BackgroundTransparency = 1
    statsFrame.Parent = uiContainer

    -- Coins display
    local coinsIcon = Instance.new("ImageLabel")
    coinsIcon.Size = UDim2.new(0, 25, 0, 25)
    coinsIcon.Position = UDim2.new(0, 0, 0, 0)
    coinsIcon.Image = "rbxassetid://6764432408"
    coinsIcon.BackgroundTransparency = 1
    coinsIcon.Parent = statsFrame

    local coinsText = Instance.new("TextLabel")
    coinsText.Size = UDim2.new(1, -30, 0, 25)
    coinsText.Position = UDim2.new(0, 30, 0, 0)
    coinsText.Text = "Coins: 0"
    coinsText.TextColor3 = Color3.new(1, 1, 1)
    coinsText.Font = Enum.Font.GothamSemibold
    coinsText.TextSize = 18
    coinsText.TextXAlignment = Enum.TextXAlignment.Left
    coinsText.BackgroundTransparency = 1
    coinsText.Parent = statsFrame

    -- Gems display
    local gemsIcon = Instance.new("ImageLabel")
    gemsIcon.Size = UDim2.new(0, 25, 0, 25)
    gemsIcon.Position = UDim2.new(0, 0, 0, 35)
    gemsIcon.Image = "rbxassetid://6764432296"
    gemsIcon.BackgroundTransparency = 1
    gemsIcon.Parent = statsFrame

    local gemsText = Instance.new("TextLabel")
    gemsText.Size = UDim2.new(1, -30, 0, 25)
    gemsText.Position = UDim2.new(0, 30, 0, 35)
    gemsText.Text = "Gems: 0"
    gemsText.TextColor3 = Color3.new(1, 1, 1)
    gemsText.Font = Enum.Font.GothamSemibold
    gemsText.TextSize = 18
    gemsText.TextXAlignment = Enum.TextXAlignment.Left
    gemsText.BackgroundTransparency = 1
    gemsText.Parent = statsFrame

    -- Controls section
    local controlsFrame = Instance.new("Frame")
    controlsFrame.Size = UDim2.new(0.9, 0, 0, 120)
    controlsFrame.Position = UDim2.new(0.05, 0, 0.4, 0)
    controlsFrame.BackgroundTransparency = 1
    controlsFrame.Parent = uiContainer

    -- Render toggle button
    local renderButton = Instance.new("TextButton")
    renderButton.Size = UDim2.new(1, 0, 0, 40)
    renderButton.Position = UDim2.new(0, 0, 0, 0)
    renderButton.Text = isRenderOff and "BẬT RENDER" or "TẮT RENDER"
    renderButton.BackgroundColor3 = Color3.new(0.2, 0.2, 0.3)
    renderButton.TextColor3 = Color3.new(1, 1, 1)
    renderButton.Font = Enum.Font.GothamBold
    renderButton.TextSize = 16
    renderButton.Parent = controlsFrame

    local renderCorner = Instance.new("UICorner")
    renderCorner.CornerRadius = UDim.new(0, 8)
    renderCorner.Parent = renderButton

    renderButton.MouseButton1Click:Connect(function()
        isRenderOff = not isRenderOff
        RunService:Set3dRenderingEnabled(not isRenderOff)
        renderButton.Text = isRenderOff and "BẬT RENDER" or "TẮT RENDER"
    end)

    -- Farm toggle button
    local farmButton = Instance.new("TextButton")
    farmButton.Size = UDim2.new(1, 0, 0, 40)
    farmButton.Position = UDim2.new(0, 0, 0, 50)
    farmButton.Text = farmEnabled and "DỪNG FARM" or "BẮT ĐẦU FARM"
    farmButton.BackgroundColor3 = Color3.new(0.3, 0.2, 0.2)
    farmButton.TextColor3 = Color3.new(1, 1, 1)
    farmButton.Font = Enum.Font.GothamBold
    farmButton.TextSize = 16
    farmButton.Parent = controlsFrame

    local farmCorner = Instance.new("UICorner")
    farmCorner.CornerRadius = UDim.new(0, 8)
    farmCorner.Parent = farmButton

    farmButton.MouseButton1Click:Connect(function()
        farmEnabled = not farmEnabled
        farmButton.Text = farmEnabled and "DỪNG FARM" or "BẮT ĐẦU FARM"
    end)

    -- Status text
    local statusText = Instance.new("TextLabel")
    statusText.Size = UDim2.new(1, 0, 0, 30)
    statusText.Position = UDim2.new(0, 0, 0.85, 0)
    statusText.Text = "Trạng thái: Đang hoạt động"
    statusText.TextColor3 = Color3.new(0, 1, 0)
    statusText.Font = Enum.Font.GothamMedium
    statusText.TextSize = 14
    statusText.BackgroundTransparency = 1
    statusText.Parent = uiContainer

    -- Update function for stats
    local function updateStats()
        local leaderstats = player:FindFirstChild("leaderstats")
        if leaderstats then
            local coins = leaderstats:GetAttribute("Coins") or 0
            local gems = leaderstats:GetAttribute("Gems") or 0
            
            -- Format numbers with commas
            coinsText.Text = "Coins: "..tostring(coins):reverse():gsub("%d%d%d", "%1,"):reverse():gsub("^,", "")
            gemsText.Text = "Gems: "..tostring(gems):reverse():gsub("%d%d%d", "%1,"):reverse():gsub("^,", "")
        end
    end

    -- Update listeners
    RunService.Heartbeat:Connect(updateStats)
    player.CharacterAdded:Connect(function()
        task.wait(1)
        updateStats()
    end)

    -- Initial update
    updateStats()
end

-- [4] FARMING FUNCTIONS
local function teleportToWinter()
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        player.Character.HumanoidRootPart.CFrame = WINTER_CFRAME
        task.wait(TELEPORT_DELAY)
    end
end

local function mount()
    dataRemoteEvent:FireServer({{
        Action = "Mount",
        Event = "MountAction",
        Name = "PurpleElder003a6e7"
    }, "\11"})
end 

local function disMount()
    dataRemoteEvent:FireServer({{
        Action = "Dismount",
        Event = "MountAction"
    }, "\11"})
end

local enemiesFolder = workspace.__Main.__Enemies.Server

local function findAliveEnemy(targetID)
    local function search(folder)
        for _, enemy in ipairs(folder:GetChildren()) do
            if enemy:GetAttribute("Id") == targetID and enemy:GetAttribute("HP") > 0 then
                return enemy 
            elseif enemy:IsA("Folder") then
                local found = search(enemy)
                if found then
                    return found
                end
            end
        end
        return nil
    end
    return search(enemiesFolder)
end

local function punchAttack(enemyData)
    local args = {
        {
            {
                Event = "PunchAttack",
                Enemy = enemyData
            },
            "\005"
        }
    }
    dataRemoteEvent:FireServer(unpack(args))
end

local function destroyEnemy(enemyData)
    local args = {
        {
            {
                Event = "EnemyDestroy",
                Enemy = enemyData
            },
            "\005"
        }
    }
    dataRemoteEvent:FireServer(unpack(args))
end

local function turnOnAutoClick()
    player:SetAttribute("AutoClick", true)
end

-- [5] MAIN FARM LOOP
local function mainFarm()
    turnOnAutoClick()
    mount()
    task.wait(1.5)
    disMount()
    
    while farmEnabled and task.wait() do
        for _, enemyID in ipairs(enemyIDList) do
            local enemyData = findAliveEnemy(enemyID)
            while enemyData and farmEnabled do
                if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    player.Character.HumanoidRootPart.CFrame = CFrame.new(enemyData.Position) * CFrame.new(0, 0, -2)
                end
                
                repeat
                    punchAttack(enemyData.Name)
                    task.wait(0.1)
                until not enemyData or enemyData:GetAttribute("HP") == 0 or not farmEnabled
                
                if enemyData and enemyData:GetAttribute("HP") == 0 then
                    for _ = 1, 5 do
                        destroyEnemy(enemyData.Name)
                        task.wait(0.3)
                    end
                end
                
                task.wait(TELEPORT_DELAY)
                enemyData = findAliveEnemy(enemyID)
            end
        end
    end
end

-- [6] INITIALIZATION
local function initialize()
    -- Initial optimization
    optimizeSystem()
    
    -- Wait for game to fully load
    ContentProvider:PreloadAsync({workspace, Lighting})
    task.wait(3)
    
    -- Create the combined UI
    createMainUI()
    
    -- Start farming
    teleportToWinter()
    mainFarm()
    
    -- Set initial render state
    RunService:Set3dRenderingEnabled(false)
end

-- Auto respawn handler
player.CharacterAdded:Connect(function(character)
    character:WaitForChild("HumanoidRootPart")
    task.wait(2)
    if farmEnabled then
        teleportToWinter()
        mainFarm()
    end
end)

-- Start everything
initialize()

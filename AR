if not game:IsLoaded() then repeat game.Loaded:Wait() until game:IsLoaded() end
-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local Lighting = game:GetService("Lighting")
local Terrain = workspace:FindFirstChildOfClass("Terrain")
local ContentProvider = game:GetService("ContentProvider")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local dataRemoteEvent = ReplicatedStorage:WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent")

-- Configuration
local TELEPORT_DELAY = 0.8
local WINTER_CFRAME = CFrame.new(4623.21924, 248.286758, -1932.66699, -0.480712414, -0.876878381, 2.60472298e-05, -2.60472298e-05, 4.38690186e-05, 1, -0.876878381, 0.480712384, -4.39882278e-05)
local enemyIDList = {"DAMB1","DAMB2","DAMB3"}
local farmEnabled = true
local isRenderOff = true

-- [1] LOADING SCREEN
local loadScreen = Instance.new("ScreenGui")
loadScreen.Name = "LoadingScreen"
loadScreen.IgnoreGuiInset = true
loadScreen.DisplayOrder = 9999

local loadFrame = Instance.new("Frame")
loadFrame.Size = UDim2.new(1, 0, 1, 0)
loadFrame.BackgroundColor3 = Color3.new(0, 0, 0)
loadFrame.Parent = loadScreen

local loadText = Instance.new("TextLabel")
loadText.Size = UDim2.new(1, 0, 0, 50)
loadText.Position = UDim2.new(0, 0, 0.5, -25)
loadText.BackgroundTransparency = 1
loadText.Text = "Đang tối ưu hóa game, vui lòng chờ..."
loadText.TextColor3 = Color3.new(1, 1, 1)
loadText.Font = Enum.Font.SourceSansBold
loadText.TextSize = 24
loadText.Parent = loadFrame

loadScreen.Parent = playerGui

-- [2] OPTIMIZATION FUNCTIONS
local function cleanUI()
    for _, child in ipairs(playerGui:GetChildren()) do
        if child.Name ~= "LoadingScreen" then
            child:Destroy()
        end
    end
end

local function optimizeSystem()
    -- Lighting optimization
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 1e10
    Lighting.Brightness = 0
    Lighting.EnvironmentDiffuseScale = 0
    Lighting.EnvironmentSpecularScale = 0
    Lighting.ClockTime = 14

    -- Terrain optimization
    if Terrain then
        Terrain.WaterWaveSize = 0
        Terrain.WaterWaveSpeed = 0
        Terrain.WaterReflectance = 0
        Terrain.WaterTransparency = 1
    end

    -- Object optimization
    for _, obj in ipairs(game:GetDescendants()) do
        if obj:IsA("Decal") or obj:IsA("Texture") then
            obj.Transparency = 1
        elseif obj:IsA("ParticleEmitter") or obj:IsA("Trail") then
            obj.Enabled = false
        end
    end

    for _, part in ipairs(workspace:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CastShadow = false
        end
    end

    -- Disable default UI
    StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.All, false)
end

-- [3] CONTINUOUS OPTIMIZATION
local function continuousOptimization()
    -- Monitor UI changes
    playerGui.ChildAdded:Connect(function(child)
        task.wait(0.1)
        if child.Name ~= "LoadingScreen" then
            cleanUI()
        end
    end)

    -- Monitor new game objects
    game.DescendantAdded:Connect(function(descendant)
        task.wait()
        if descendant:IsA("Decal") or descendant:IsA("Texture") then
            descendant.Transparency = 1
        elseif descendant:IsA("ParticleEmitter") or descendant:IsA("Trail") then
            descendant.Enabled = false
        elseif descendant:IsA("BasePart") then
            descendant.CastShadow = false
        end
    end)

    -- Periodic optimization
    while task.wait(30) do
        optimizeSystem()
        cleanUI()
    end
end

-- [4] GUI FUNCTIONS
local function createStatsUI()
    local function formatNumber(num)
        if not num or type(num) ~= "number" then return "0" end
        
        local suffixes = {"", "k", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No"}
        local absNum = math.abs(num)
        local suffixIndex = math.min(#suffixes, math.floor(math.log10(absNum)/3 + 1))
        
        local value = absNum / 10^(3*(suffixIndex-1))
        local formatted = (value >= 100 and math.floor(value) or math.floor(value * 10)/10)
        
        return (num < 0 and "-" or "")..tostring(formatted):gsub("%.0$", "")..suffixes[suffixIndex]
    end

    -- Create UI
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PlayerStatsUI"
    screenGui.Parent = game:GetService("CoreGui")

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 250, 0, 180)
    frame.Position = UDim2.new(0.02, 0, 0.02, 0)
    frame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    frame.BackgroundTransparency = 0.2
    frame.BorderSizePixel = 0
    frame.ClipsDescendants = true
    frame.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame

    -- ICON IDs
    local COINS_ICON = "rbxassetid://6764432408"
    local GEMS_ICON = "rbxassetid://6764432296"

    -- Create label helper
    local function createLabel(name, position, isTitle, isCredit)
        local label = Instance.new("TextLabel")
        label.Name = name
        label.Size = isCredit and UDim2.new(1, 0, 0, 20) or UDim2.new(0.9, 0, 0, isTitle and 30 or 25)
        label.Position = position
        label.TextColor3 = isCredit and Color3.fromRGB(150, 150, 150) or 
                          (isTitle and Color3.fromRGB(255, 215, 100) or Color3.fromRGB(220, 220, 255))
        label.BackgroundTransparency = 1
        label.Font = isCredit and Enum.Font.Gotham or 
                    (isTitle and Enum.Font.GothamBlack or Enum.Font.GothamSemibold)
        label.TextSize = isCredit and 12 or (isTitle and 18 or 16)
        label.TextXAlignment = isCredit and Enum.TextXAlignment.Center or Enum.TextXAlignment.Left
        label.Parent = frame
        return label
    end

    -- Create icon helper
    local function createIcon(name, position, image)
        local icon = Instance.new("ImageLabel")
        icon.Name = name
        icon.Size = UDim2.new(0, 25, 0, 25)
        icon.Position = position
        icon.BackgroundTransparency = 1
        icon.Image = image
        icon.Parent = frame
        return icon
    end

    -- Main UI elements
    local titleLabel = createLabel("Title", UDim2.new(0.05, 0, 0.05, 0), true)
    titleLabel.Text = player.Name

    createIcon("CoinsIcon", UDim2.new(0.05, 0, 0.35, 0), COINS_ICON)
    local coinsLabel = createLabel("CoinsLabel", UDim2.new(0.15, 0, 0.35, 0))
    coinsLabel.Text = "Coins: 0"

    createIcon("GemsIcon", UDim2.new(0.05, 0, 0.6, 0), GEMS_ICON)
    local gemsLabel = createLabel("GemsLabel", UDim2.new(0.15, 0, 0.6, 0))
    gemsLabel.Text = "Gems: 0"

    local creditLabel = createLabel("Credit", UDim2.new(0, 0, 0.85, 0), false, true)
    creditLabel.Text = "Made by @_lnch"

    -- UI update function
    local function updateUI()
        local leaderstats = player:FindFirstChild("leaderstats")
        if leaderstats then
            coinsLabel.Text = "Coins: "..formatNumber(leaderstats:GetAttribute("Coins") or 0)
            gemsLabel.Text = "Gems: "..formatNumber(leaderstats:GetAttribute("Gems") or 0)
        end
    end

    -- Update listeners
    RunService.Heartbeat:Connect(updateUI)
    player.CharacterAdded:Connect(function()
        task.wait(1)
        updateUI()
    end)

    updateUI()
end

local function createControlGUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "AutoFarmGUI"
    ScreenGui.Parent = game.CoreGui

    -- Render Toggle Button
    local renderToggleButton = Instance.new("TextButton")
    renderToggleButton.Size = UDim2.new(0, 120, 0, 40)
    renderToggleButton.Position = UDim2.new(0, 20, 0, 70)
    renderToggleButton.Text = isRenderOff and "Bật Render" or "Tắt Render"
    renderToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    renderToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    renderToggleButton.Font = Enum.Font.GothamBold
    renderToggleButton.TextSize = 14
    renderToggleButton.Parent = ScreenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = renderToggleButton

    renderToggleButton.MouseButton1Click:Connect(function()
        isRenderOff = not isRenderOff
        RunService:Set3dRenderingEnabled(not isRenderOff)
        renderToggleButton.Text = isRenderOff and "Bật Render" or "Tắt Render"
    end)

    -- Farm Toggle Button
    local farmToggleButton = Instance.new("TextButton")
    farmToggleButton.Size = UDim2.new(0, 120, 0, 40)
    farmToggleButton.Position = UDim2.new(0, 20, 0, 120)
    farmToggleButton.Text = farmEnabled and "Tắt Auto Farm" or "Bật Auto Farm"
    farmToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    farmToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    farmToggleButton.Font = Enum.Font.GothamBold
    farmToggleButton.TextSize = 14
    farmToggleButton.Parent = ScreenGui
    
    local corner2 = Instance.new("UICorner")
    corner2.CornerRadius = UDim.new(0, 6)
    corner2.Parent = farmToggleButton

    farmToggleButton.MouseButton1Click:Connect(function()
        farmEnabled = not farmEnabled
        farmToggleButton.Text = farmEnabled and "Tắt Auto Farm" or "Bật Auto Farm"
    end)

    -- Initial render state
    RunService:Set3dRenderingEnabled(false)
end

-- [5] FARMING FUNCTIONS
local function teleportToWinter()
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        player.Character.HumanoidRootPart.CFrame = WINTER_CFRAME
        task.wait(TELEPORT_DELAY)
    end
end

local function mount()
    dataRemoteEvent:FireServer({{
        Action = "Mount",
        Event = "MountAction",
        Name = "PurpleElder003a6e7"
    }, "\11"})
end 

local function disMount()
    dataRemoteEvent:FireServer({{
        Action = "Dismount",
        Event = "MountAction"
    }, "\11"})
end

local enemiesFolder = workspace.__Main.__Enemies.Server

local function findAliveEnemy(targetID)
    local function search(folder)
        for _, enemy in ipairs(folder:GetChildren()) do
            if enemy:GetAttribute("Id") == targetID and enemy:GetAttribute("HP") > 0 then
                return enemy 
            elseif enemy:IsA("Folder") then
                local found = search(enemy)
                if found then
                    return found
                end
            end
        end
        return nil
    end
    return search(enemiesFolder)
end

local function punchAttack(enemyData)
    local args = {
        {
            {
                Event = "PunchAttack",
                Enemy = enemyData
            },
            "\005"
        }
    }
    dataRemoteEvent:FireServer(unpack(args))
end

local function destroyEnemy(enemyData)
    local args = {
        {
            {
                Event = "EnemyDestroy",
                Enemy = enemyData
            },
            "\005"
        }
    }
    dataRemoteEvent:FireServer(unpack(args))
end

local function turnOnAutoClick()
    player:SetAttribute("AutoClick", true)
end

-- [6] MAIN FARM LOOP
local function mainfarm()
    turnOnAutoClick()
    mount()
    task.wait(1.5)
    disMount()
    
    while farmEnabled and task.wait() do
        for _, enemyID in ipairs(enemyIDList) do
            local enemyData = findAliveEnemy(enemyID)
            while enemyData and farmEnabled do
                if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    player.Character.HumanoidRootPart.CFrame = CFrame.new(enemyData.Position) * CFrame.new(0, 0, -2)
                end
                
                repeat
                    punchAttack(enemyData.Name)
                    task.wait(0.1)
                until not enemyData or enemyData:GetAttribute("HP") == 0 or not farmEnabled
                
                if enemyData and enemyData:GetAttribute("HP") == 0 then
                    for _ = 1, 5 do
                        destroyEnemy(enemyData.Name)
                        task.wait(0.3)
                    end
                end
                
                task.wait(TELEPORT_DELAY)
                enemyData = findAliveEnemy(enemyID)
            end
        end
    end
end

-- [7] INITIALIZATION
local function initialize()
    -- Initial optimization
    optimizeSystem()
    cleanUI()
    
    -- Wait for game to fully load
    ContentProvider:PreloadAsync({workspace, Lighting})
    task.wait(3)
    
    -- Remove loading screen
    if loadScreen then
        loadScreen:Destroy()
    end
    
    -- Create UIs
    createStatsUI()
    createControlGUI()
    
    -- Start continuous optimization
    coroutine.wrap(continuousOptimization)()
    
    -- Start farming
    teleportToWinter()
    mainfarm()
    
    print("✅ FPS Boost VIP Activated!")
end

-- Auto respawn handler
player.CharacterAdded:Connect(function(character)
    character:WaitForChild("HumanoidRootPart")
    task.wait(2)
    if farmEnabled then
        teleportToWinter()
        mainfarm()
    end
end)

-- Start everything
initialize()

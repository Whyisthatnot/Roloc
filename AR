repeat wait() until game:IsLoaded() and game.Players.LocalPlayer 
if not game:IsLoaded() then 
    repeat task.wait() until game:IsLoaded() 
end

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local Lighting = game:GetService("Lighting")
local Terrain = workspace:FindFirstChildOfClass("Terrain")
local ContentProvider = game:GetService("ContentProvider")
local UserInputService = game:GetService("UserInputService")
local VirtualUser = game:GetService("VirtualUser")

-- Player setup
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local dataRemoteEvent = ReplicatedStorage:WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent")

-- Configuration
local TELEPORT_DELAY = 0.8
local WINTER_CFRAME = CFrame.new(4623.21924, 248.286758, -1932.66699, -0.480712414, -0.876878381, 2.60472298e-05, -2.60472298e-05, 4.38690186e-05, 1, -0.876878381, 0.480712384, -4.39882278e-05)
local enemyIDList = {"DAMB1","DAMB2","DAMB3"}
local KINDAMA_CFRAME = CFrame.new(-4487.57031, 32.6948891, 5918.12744, -0.384795666, 0, -0.923001766, 0, 1, 0, 0.923001766, 0, -0.384795666)
local farmEnabled = true
local isRenderOff = true

-- Anti-AFK function
local function antiAFK()
    while true do
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
        task.wait(30)
    end
end

local function teleportToKindama()
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        player.Character.HumanoidRootPart.CFrame = KINDAMA_CFRAME
        task.wait(TELEPORT_DELAY)
    end
end
-- Loading screen
local function createLoadingScreen()
    local loadScreen = Instance.new("ScreenGui")
    loadScreen.Name = "LoadingScreen"
    loadScreen.IgnoreGuiInset = true
    loadScreen.DisplayOrder = 9999

    local loadFrame = Instance.new("Frame")
    loadFrame.Size = UDim2.new(1, 0, 1, 0)
    loadFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    loadFrame.Parent = loadScreen

    local loadText = Instance.new("TextLabel")
    loadText.Size = UDim2.new(1, 0, 0, 50)
    loadText.Position = UDim2.new(0, 0, 0.5, -25)
    loadText.BackgroundTransparency = 1
    loadText.Text = "Đang tối ưu hóa game, vui lòng chờ..."
    loadText.TextColor3 = Color3.new(1, 1, 1)
    loadText.Font = Enum.Font.SourceSansBold
    loadText.TextSize = 24
    loadText.Parent = loadFrame

    loadScreen.Parent = playerGui
    return loadScreen
end

-- Optimization functions
local function cleanUI()
    for _, child in ipairs(playerGui:GetChildren()) do
        task.wait(0.1)
        if child.Name ~= "LoadingScreen" then
            child:Destroy()
        end
    end
end

local function optimizeSystem()
    -- Lighting optimization
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 1e10
    Lighting.Brightness = 0
    Lighting.EnvironmentDiffuseScale = 0
    Lighting.EnvironmentSpecularScale = 0
    Lighting.ClockTime = 14

    -- Terrain optimization
    if Terrain then
        Terrain.WaterWaveSize = 0
        Terrain.WaterWaveSpeed = 0
        Terrain.WaterReflectance = 0
        Terrain.WaterTransparency = 1
    end

    -- Object optimization
    for _, obj in ipairs(game:GetDescendants()) do
        if obj:IsA("Decal") or obj:IsA("Texture") then
            obj.Transparency = 1
        elseif obj:IsA("ParticleEmitter") or obj:IsA("Trail") then
            obj.Enabled = false
        elseif obj:IsA("BasePart") then
            obj.CastShadow = false
        end
    end

    -- Disable default UI
    StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.All, false)
end

-- GUI functions
local function makeDraggable(gui, handle)
    local dragging, dragInput, dragStart, startPos

    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = gui.AbsolutePosition
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            gui.Position = UDim2.new(
                0, startPos.X + delta.X,
                0, startPos.Y + delta.Y
            )
        end
    end)
end

local function createStatsUI()
    local function formatNumber(num)
        if not num or type(num) ~= "number" then return "0" end
        
        local suffixes = {"", "k", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No"}
        local absNum = math.abs(num)
        local suffixIndex = math.min(#suffixes, math.floor(math.log10(absNum)/3 + 1))
        
        local value = absNum / 10^(3*(suffixIndex-1))
        local formatted = (value >= 100 and math.floor(value) or math.floor(value * 10)/10)
        
        return (num < 0 and "-" or "")..tostring(formatted):gsub("%.0$", "")..suffixes[suffixIndex]
    end

    -- Create UI
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PlayerStatsUI"
    screenGui.Parent = playerGui
    screenGui.ResetOnSpawn = false

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 250, 0, 180)
    frame.Position = UDim2.new(0.02, 0, 0.3, 0)
    frame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    frame.BackgroundTransparency = 0.2
    frame.BorderSizePixel = 0
    frame.ClipsDescendants = true
    frame.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame

    -- ICON IDs
    local COINS_ICON = "rbxassetid://"
    local GEMS_ICON = "rbxassetid://"

    -- Create label helper
    local function createLabel(name, position, isTitle, isCredit)
        local label = Instance.new("TextLabel")
        label.Name = name
        label.Size = isCredit and UDim2.new(1, 0, 0, 20) or UDim2.new(0.9, 0, 0, isTitle and 30 or 25)
        label.Position = position
        label.TextColor3 = isCredit and Color3.fromRGB(150, 150, 150) or 
                          (isTitle and Color3.fromRGB(255, 215, 100) or Color3.fromRGB(220, 220, 255))
        label.BackgroundTransparency = 1
        label.Font = isCredit and Enum.Font.Gotham or 
                    (isTitle and Enum.Font.GothamBlack or Enum.Font.GothamSemibold)
        label.TextSize = isCredit and 12 or (isTitle and 18 or 16)
        label.TextXAlignment = isCredit and Enum.TextXAlignment.Center or Enum.TextXAlignment.Left
        label.Parent = frame
        return label
    end

    -- Create icon helper
    local function createIcon(name, position, image)
        local icon = Instance.new("ImageLabel")
        icon.Name = name
        icon.Size = UDim2.new(0, 25, 0, 25)
        icon.Position = position
        icon.BackgroundTransparency = 1
        icon.Image = image
        icon.Parent = frame
        return icon
    end

    -- Main UI elements
    local titleLabel = createLabel("Title", UDim2.new(0.05, 0, 0.05, 0), true)
    titleLabel.Text = player.Name
    titleLabel.Size = UDim2.new(0.9, 0, 0, 30)
    makeDraggable(screenGui, titleLabel)

    createIcon("CoinsIcon", UDim2.new(0.05, 0, 0.35, 0), COINS_ICON)
    local coinsLabel = createLabel("CoinsLabel", UDim2.new(0.15, 0, 0.35, 0))
    coinsLabel.Text = "Coins: 0"

    createIcon("GemsIcon", UDim2.new(0.05, 0, 0.6, 0), GEMS_ICON)
    local gemsLabel = createLabel("GemsLabel", UDim2.new(0.15, 0, 0.6, 0))
    gemsLabel.Text = "Gems: 0"

    local creditLabel = createLabel("Credit", UDim2.new(0, 0, 0.85, 0), false, true)
    creditLabel.Text = "Made by @_lnch"

    -- UI update function
    local function updateUI()
        local leaderstats = player:FindFirstChild("leaderstats")
        if leaderstats then
            coinsLabel.Text = "Coins: "..formatNumber(leaderstats:GetAttribute("Coins") or 0)
            gemsLabel.Text = "Gems: "..formatNumber(leaderstats:GetAttribute("Gems") or 0)
        end
    end

    -- Update listeners
    local heartbeatConnection
    heartbeatConnection = RunService.Heartbeat:Connect(updateUI)
    
    player.CharacterAdded:Connect(function()
        task.wait(1)
        updateUI()
    end)

    updateUI()
    
    return {
        Destroy = function()
            heartbeatConnection:Disconnect()
            screenGui:Destroy()
        end
    }
end

local function createControlGUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "AutoFarmGUI"
    ScreenGui.Parent = playerGui
    ScreenGui.ResetOnSpawn = false

    -- Giảm kích thước main frame
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 120, 0, 100)  -- Giảm từ 160x160 xuống 120x100
    mainFrame.Position = UDim2.new(0.02, 0, 0.02, 0)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    mainFrame.BackgroundTransparency = 0.2
    mainFrame.BorderSizePixel = 0
    mainFrame.ClipsDescendants = true
    mainFrame.Parent = ScreenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)  -- Giảm góc bo từ 8 xuống 6
    corner.Parent = mainFrame

    local titleBar = Instance.new("TextLabel")
    titleBar.Size = UDim2.new(1, 0, 0, 24)  -- Giảm chiều cao từ 30 xuống 24
    titleBar.Text = "Auto Farm"
    titleBar.TextColor3 = Color3.fromRGB(255, 215, 100)
    titleBar.BackgroundTransparency = 1
    titleBar.Font = Enum.Font.GothamMedium  -- Đổi font cho gọn
    titleBar.TextSize = 14  -- Giảm từ 16 xuống 14
    titleBar.Parent = mainFrame
    makeDraggable(ScreenGui, titleBar)

    local renderToggleButton = Instance.new("TextButton")
    renderToggleButton.Size = UDim2.new(0.85, 0, 0, 28)  -- Giảm kích thước
    renderToggleButton.Position = UDim2.new(0.075, 0, 0.3, 0)  -- Điều chỉnh vị trí
    renderToggleButton.Text = isRenderOff and "Bật Render" or "Tắt Render"
    renderToggleButton.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    renderToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    renderToggleButton.Font = Enum.Font.Gotham  -- Đổi font
    renderToggleButton.TextSize = 12  -- Giảm kích thước chữ
    renderToggleButton.Parent = mainFrame
    
    local cornerBtn = Instance.new("UICorner")
    cornerBtn.CornerRadius = UDim.new(0, 5)  -- Giảm góc bo
    cornerBtn.Parent = renderToggleButton

    -- Nút farm nhỏ hơn
    local farmToggleButton = Instance.new("TextButton")
    farmToggleButton.Size = UDim2.new(0.85, 0, 0, 28)  -- Đồng bộ kích thước
    farmToggleButton.Position = UDim2.new(0.075, 0, 0.65, 0)  -- Căn chỉnh vị trí
    farmToggleButton.Text = farmEnabled and "Tắt Farm" or "Bật Farm"  -- Rút gọn text
    farmToggleButton.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    farmToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    farmToggleButton.Font = Enum.Font.Gotham
    farmToggleButton.TextSize = 12
    farmToggleButton.Parent = mainFrame
    
    local cornerBtn2 = Instance.new("UICorner")
    cornerBtn2.CornerRadius = UDim.new(0, 5)
    cornerBtn2.Parent = farmToggleButton

    -- Thêm hiệu ứng hover
    local function buttonHoverEffect(button)
        button.MouseEnter:Connect(function()
            button.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
        end)
        
        button.MouseLeave:Connect(function()
            button.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        end)
    end

    buttonHoverEffect(renderToggleButton)
    buttonHoverEffect(farmToggleButton)

    -- Xử lý sự kiện click
    renderToggleButton.MouseButton1Click:Connect(function()
        isRenderOff = not isRenderOff
        RunService:Set3dRenderingEnabled(not isRenderOff)
        renderToggleButton.Text = isRenderOff and "Bật Render" or "Tắt Render"
    end)

    farmToggleButton.MouseButton1Click:Connect(function()
        farmEnabled = not farmEnabled
        farmToggleButton.Text = farmEnabled and "Tắt Farm" or "Bật Farm"
    end)

    RunService:Set3dRenderingEnabled(not isRenderOff)
    
    return ScreenGui
end



local function mount()
    dataRemoteEvent:FireServer({{
        Action = "Mount",
        Event = "MountAction",
        Name = "PurpleElder003a6e7"
    }, "\11"})
end 

local function disMount()
    dataRemoteEvent:FireServer({{
        Action = "Dismount",
        Event = "MountAction"
    }, "\11"})
end

local function findAliveEnemy(targetID)
    local enemiesFolder = workspace.__Main.__Enemies.Server
    
    local function search(folder)
        for _, enemy in ipairs(folder:GetChildren()) do
            if enemy:GetAttribute("Id") == targetID and enemy:GetAttribute("HP") > 0 then
                return enemy 
            elseif enemy:IsA("Folder") then
                local found = search(enemy)
                if found then
                    return found
                end
            end
        end
        return nil
    end
    
    return search(enemiesFolder)
end

local function punchAttack(enemyData)
    local args = {
        {
            {
                Event = "PunchAttack",
                Enemy = enemyData
            },
            "\005"
        }
    }
    dataRemoteEvent:FireServer(unpack(args))
end

local function autoAttack(name,pos)
    task.wait(0.6)
    local player = Players.LocalPlayer
    local playerId = tostring(player.UserId)
    
    -- Lấy folder pet của người chơi
    local playerFolder = workspace.__Main.__Pets:FindFirstChild(playerId)
    if not playerFolder then
        warn("📦 Không tìm thấy folder pet cho ID:", playerId)
        return
    end

    -- Tạo vector từ vị trí kẻ địch
    local defaultVector = pos
	
    -- Tạo bảng PetPos
    local PetPos = {}
    for _, pet in ipairs(playerFolder:GetChildren()) do
        if pet:IsA("Folder") then
            PetPos[pet.Name] = defaultVector
        end
    end
    
    
    local args = {{
        {
            PetPos = PetPos,
            AttackType = "All",
            Event = "Attack",
            Enemy = name
        },
        "\006"
    }}

    dataRemoteEvent:FireServer(unpack(args))
    task.wait(0.1)
    local args = {
        {
            {
                Event = "ShowPets"
            },
            "\006"
        }
    }
    game:GetService("ReplicatedStorage"):WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent"):FireServer(unpack(args))
    
end



local function destroyEnemy(enemyData)
    local args = {
        {
            {
                Event = "EnemyDestroy",
                Enemy = enemyData
            },
            "\005"
        }
    }
    dataRemoteEvent:FireServer(unpack(args))
end

local function ariseEnemy(enemyData)
    local args = {
        {
            {
                Event = "EnemyCapture",
                Enemy = enemyData
            },
            "\005"
        }
    }
    dataRemoteEvent:FireServer(unpack(args))
end

local function turnOnAutoClick()
    player:SetAttribute("AutoClick", true)
end
local isHandlingBoss = false
local isFarming = false

local function mainFarm()
    task.spawn(function()
        isFarming = true
        mount()
        task.wait(1.5)
        disMount()

        while true do
            -- Nếu đang xử lý boss hoặc tắt farm thì dừng
            if not farmEnabled or isHandlingBoss then
                task.wait(0.5)
                continue
            end

            for _, enemyID in ipairs(enemyIDList) do
                if not farmEnabled or isHandlingBoss then break end

                local enemyData = findAliveEnemy(enemyID)
                while enemyData and farmEnabled and not isHandlingBoss do
                    -- Dịch chuyển tới quái
                    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                        player.Character.HumanoidRootPart.CFrame = CFrame.new(enemyData.Position) * CFrame.new(0, 0, -2)
                    end

                    punchAttack(enemyData.Name)
                    autoAttack(enemyData.Name, enemyData.Position)

                    -- Đợi đánh quái
                    while enemyData and enemyData:GetAttribute("HP") > 0 and farmEnabled and not isHandlingBoss do
                        task.wait(0.1)
                    end

                    if not farmEnabled or isHandlingBoss then break end

                    -- Tiêu diệt quái sau khi HP = 0
                    for _ = 1, 5 do
                        destroyEnemy(enemyData.Name)
                        task.wait(0.3)
                    end

                    task.wait(TELEPORT_DELAY)
                    enemyData = findAliveEnemy(enemyID)
                end
            end

            task.wait(0.2)
        end
    end)
end

local function handleWinterBoss()
    if isHandlingBoss then return end -- Đã xử lý thì thôi

    isHandlingBoss = true
    farmEnabled = false

    -- Xử lý boss
    local character = player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        warn("⚠️ Không có nhân vật!")
        isHandlingBoss = false
        farmEnabled = true
        return
    end

    -- Teleport tới vị trí boss
    pcall(function()
        character.HumanoidRootPart.CFrame = WINTER_CFRAME
        task.wait(TELEPORT_DELAY)
    end)

    -- Tìm boss
    local bossData
    local success, err = pcall(function()
        bossData = findAliveEnemy("WBoss")
    end)

    if not success or not bossData then
        -- 🛑 Boss không còn (do bị người khác kill mất)
        warn("❌ Boss không còn, tiếp tục farm thường.")
        pcall(teleportToKindama)

        -- RESET TRẠNG THÁI
        isHandlingBoss = false
        farmEnabled = true
        return
    end

    -- Nếu có boss, xử lý boss
    local bossHRP = bossData:FindFirstChild("HumanoidRootPart")
    if bossHRP then
        character.HumanoidRootPart.CFrame = bossHRP.CFrame * CFrame.new(0, 3, -5)
    end

    while bossData and bossData:GetAttribute("HP") and bossData:GetAttribute("HP") > 0 and isHandlingBoss do
        pcall(autoAttack, bossData.Name, bossData.Position)
        pcall(punchAttack, bossData.Name)
        task.wait(0.1)
    end

    -- Capture boss khi chết
    if bossData and bossData:GetAttribute("HP") and bossData:GetAttribute("HP") <= 0 then
        for _ = 1, 5 do
            ariseEnemy(bossData.Name)
            task.wait(0.3)
        end
    end

    pcall(teleportToKindama)

    -- ✅ Reset trạng thái để tiếp tục farm thường
    print("✅ Boss xử lý xong hoặc không còn.")
    isHandlingBoss = false
    farmEnabled = true
end

local function startBossTimerChecker()
    task.spawn(function()
        while true do
            local minutes = os.date("*t").min
            if minutes >= 11 and minutes < 25 then
                if not isHandlingBoss then
                    print("⏳ Giai đoạn boss! Chuẩn bị...")
                    handleWinterBoss()
                end
            end
            task.wait(5)
        end
    end)
end
-- Initialization
local function initialize()
    task.wait(3)
    local loadingScreen = createLoadingScreen()
    ContentProvider:PreloadAsync({workspace, Lighting})
    task.wait(0.5)
    cleanUI()
    optimizeSystem()
    createStatsUI()
    loadingScreen:Destroy()
    createControlGUI()
    coroutine.wrap(antiAFK)()
    mainFarm()
    startBossTimerChecker()
    print("✅ FPS Boost VIP Activated!")
end
mainFarm()
startBossTimerChecker()

